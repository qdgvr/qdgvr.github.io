<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>P√©rdida de retroalimentaci√≥n en una sociedad de alquileres</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700;900&family=Source+Serif+4:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #111;
      --panel: #151515;
      --panel-dark: #121212;
      --text: #f5f5f5;
      --muted: #b3b3b3;
      --accent: #6fd3ff;
      --border: #2a2a2a;
      --blue: #0b82ff;
      --yellow: #f6c344;
      --no-data: #444;
      --palette-1: #264b83;
      --palette-2: #3b6aa6;
      --palette-3: #5386c5;
      --palette-4: #73a5db;
      --palette-5: #9fc3ed;
      --shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "Source Serif 4", Georgia, "Times New Roman", serif;
      line-height: 1.7;
      -webkit-font-smoothing: antialiased;
    }
    a { color: #8dc9ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: #171717;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 1px 0 rgba(255,255,255,0.04);
    }
    .header-inner {
      width: 100%;
      padding: 12px 30px 10px;
    }
    .top-bar {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      max-width: 1440px;
      margin: 0 auto;
    }
    .icon-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      border-radius: 50%;
      display: grid;
      place-items: center;
      color: #c7c7c7;
      background: transparent;
      font-size: 18px;
      position: absolute;
      left: 6px;
    }
    .logo {
      font-family: "Playfair Display", Georgia, serif;
      font-weight: 700;
      font-size: 22px;
      text-align: center;
      line-height: 1.1;
      letter-spacing: -0.4px;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 8px;
      width: 260px;
    }
    .logo small {
      display: block;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      font-size: 11px;
      color: var(--muted);
      font-weight: 400;
      margin-top: 4px;
    }
    .header-actions {
      position: absolute;
      right: 6px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      color: #f1f1f1;
      font-size: 14px;
    }
    .avatar-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid var(--border);
      display: grid;
      place-items: center;
      color: #d9d9d9;
      background: #1f1f1f;
      font-size: 16px;
    }
    .nav-row {
      max-width: 1080px;
      margin: 0 auto;
      padding: 0 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    .subnav {
      display: inline-flex;
      gap: 18px;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }
    .subnav a {
      color: #dcdcdc;
      font-weight: 600;
      text-decoration: none;
    }
    .subnav a:first-child {
      color: #fff;
      font-weight: 700;
    }
    .article-intro {
      max-width: 880px;
      margin: 18px auto 12px;
      padding: 0 8px;
    }
    .article-title {
      font-family: "Playfair Display", Georgia, serif;
      font-weight: 900;
      font-size: 36px;
      line-height: 1.15;
      margin: 0 0 10px;
      color: #fdfdfd;
    }
    .article-subtitle {
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      font-size: 16px;
      color: var(--muted);
      margin: 0 0 12px;
      line-height: 1.6;
    }
    .article-body {
      font-size: 17px;
      line-height: 1.7;
      color: #e8e8e8;
      margin: 0 0 14px;
    }
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 140px 20px 80px;
    }
    .hero {
      max-width: 880px;
      margin: 16px auto 28px;
      padding: 0 8px;
    }
    .kicker {
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 14px;
    }
    h1 {
      font-family: "Playfair Display", Georgia, serif;
      font-weight: 900;
      font-size: 54px;
      line-height: 1.1;
      margin: 0 0 18px;
      color: #fdfdfd;
    }
    .dek {
      font-size: 19px;
      color: #e2e2e2;
      margin: 0 0 18px;
      line-height: 1.6;
    }
    .date {
      color: var(--muted);
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      margin: 0 0 12px;
      font-size: 15px;
    }
    .save-share {
      display: flex;
      gap: 10px;
      margin: 10px 0 24px;
    }
    .save-share button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #1a1a1a;
      font-size: 12px;
      color: #e0e0e0;
      cursor: pointer;
    }
    .save-share button:hover { background: #202020; }
    .map-stack {
      display: flex;
      flex-direction: column;
      gap: 26px;
    }
    /* Map + metric styles (kept functional, retinted for dark theme) */
    .metric-block {
      margin: 0;
      padding: 14px;
      border-radius: 12px;
      background: var(--panel-dark);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      color: var(--text);
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(260px, 1.3fr);
      gap: 16px;
      align-items: start;
    }
    .map-block {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .map-shell {
      position: relative;
      background: #111;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: inset 0 1px 0 #1d1d1d;
      min-height: 520px;
    }
    .map-target svg { display: block; }
    .map-search-btn {
      position: absolute;
      top: 14px;
      left: 14px;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #1b1b1b;
      color: var(--accent);
      font-size: 18px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
    }
    .map-search-btn:hover { transform: translateY(-1px); }
    .map-search-panel {
      position: absolute;
      top: 62px;
      left: 14px;
      width: 220px;
      background: #171717;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 10px;
      display: none;
      z-index: 5;
    }
    .map-search-panel.open { display: block; }
    .map-search-panel input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #2f2f2f;
      margin-bottom: 8px;
      font-size: 13px;
      background: #111;
      color: var(--text);
    }
    .map-search-panel .search-list {
      max-height: 160px;
      overflow-y: auto;
    }
    .map-search-panel button {
      width: 100%;
      text-align: left;
      border: none;
      background: none;
      padding: 4px 2px;
      cursor: pointer;
      font-size: 13px;
      color: var(--accent);
    }
    .year-select {
      position: absolute;
      top: 14px;
      left: 66px;
      display: inline-flex;
      flex-direction: column;
      gap: 6px;
      z-index: 6;
    }
    .year-select-btn {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #1b1b1b;
      color: var(--text);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      box-shadow: var(--shadow);
      min-width: 110px;
      text-align: left;
    }
    .year-dropdown {
      display: none;
      position: absolute;
      top: 46px;
      left: 0;
      background: #171717;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 6px;
      min-width: 110px;
      max-height: 220px;
      overflow-y: auto;
    }
    .year-dropdown.open { display: block; }
    .year-dropdown button {
      width: 100%;
      border: none;
      background: none;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      text-align: left;
      font-size: 13px;
      color: var(--text);
    }
    .year-dropdown button:hover { background: #1f1f1f; }
    .map-zoom {
      position: absolute;
      top: 14px;
      right: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .zoom-btn {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #1b1b1b;
      font-size: 20px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow);
      color: var(--text);
    }
    .legend-steps {
      background: #131313;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: inset 0 1px 0 #1d1d1d;
    }
    .legend-title { font-weight: 700; color: #f2f2f2; margin-bottom: 10px; font-family: "Inter", "Helvetica Neue", Arial, sans-serif; }
    .legend-steps-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-bottom: 10px;
      align-items: stretch;
    }
    .legend-step {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      padding: 8px 6px;
      border-radius: 8px;
      background: #171717;
      border: 1px solid #2a2a2a;
      font-size: 12px;
      color: var(--muted);
    }
    .legend-chip {
      width: 100%;
      height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.2);
    }
    .legend-caption {
      font-size: 12px;
      color: #8a8a8a;
      line-height: 1.5;
    }
    .state-card {
      background: #131313;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      padding: 18px 18px;
      position: sticky;
      top: 20px;
      color: var(--text);
    }
    .state-card-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .state-card-subtitle { font-size: 13px; color: var(--muted); margin-bottom: 14px; line-height: 1.5; }
    .state-card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .state-card-box {
      background: #0f0f0f;
      border-radius: 10px;
      padding: 12px;
      border: 1px solid #2a2a2a;
    }
    .state-card-label { font-size: 11px; text-transform: uppercase; letter-spacing: .05em; color: #7e8a9b; margin-bottom: 4px; }
    .state-card-value { font-size: 18px; font-weight: 800; }
    .state-card-rank { font-size: 16px; font-weight: 700; color: var(--accent); }
    .ranking-section {
      margin-top: 14px;
      background: #131313;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      padding: 14px 16px 16px;
    }
    .ranking-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px; margin-bottom: 10px; }
    .ranking-column-title { font-weight: 700; font-size: 14px; margin-bottom: 8px; color: #f2f2f2; }
    .ranking-list { list-style: none; margin: 0; padding: 0; }
    .ranking-list li {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) auto auto;
      gap: 8px;
      align-items: center;
      padding: 4px 0;
      font-size: 13px;
      color: var(--text);
    }
    .ranking-list button {
      border: none;
      background: none;
      padding: 0;
      text-align: left;
      cursor: pointer;
      color: var(--accent);
      font-weight: 600;
    }
    .ranking-rank, .ranking-value { font-variant-numeric: tabular-nums; font-size: 12px; color: #c6c6c6; text-align: right; }
    #view-all-btn,
    #view-all-btn-fmd,
    #view-all-btn-poorhlth {
      margin-top: 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 7px 14px;
      font-size: 13px;
      background: #1a1a1a;
      cursor: pointer;
      color: var(--text);
    }
    #view-all-btn:hover,
    #view-all-btn-fmd:hover,
    #view-all-btn-poorhlth:hover { background: #202020; }
    #all-states-modal,
    #all-states-modal-fmd,
    #all-states-modal-poorhlth {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    #all-states-modal.open,
    #all-states-modal-fmd.open,
    #all-states-modal-poorhlth.open { display: flex; }
    .modal-panel {
      background: #111;
      border-radius: 12px;
      max-width: 960px;
      width: 96%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .modal-header {
      padding: 14px 18px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #2a2a2a;
    }
    .modal-title { font-size: 18px; font-weight: 700; }
    .modal-close {
      border: none;
      background: none;
      font-size: 20px;
      cursor: pointer;
      line-height: 1;
      color: var(--text);
    }
    .modal-body { padding: 10px 18px 16px; overflow: auto; }
    table { border-collapse: collapse; width: 100%; font-size: 13px; color: var(--text); }
    thead th { text-align: left; padding: 6px 4px; border-bottom: 1px solid #2f2f2f; font-weight: 600; color: #e0e0e0; }
    tbody td { padding: 5px 4px; border-bottom: 1px solid #1e1e1e; }
    .td-right { text-align: right; font-variant-numeric: tabular-nums; }
    .modal-state-button {
      border: none;
      background: none;
      padding: 0;
      color: var(--accent);
      cursor: pointer;
      text-align: left;
    }
    .modal-state-button:hover { text-decoration: underline; }
    .tooltip {
      position: absolute;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      padding: 10px 12px;
      font-size: 13px;
      line-height: 1.4;
      pointer-events: none;
      opacity: 0;
      z-index: 20;
      border: 1px solid #e4e8ef;
      color: #111;
    }
    .trend-tooltip {
      position: absolute;
      background: #0f0f0f;
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 6px 8px;
      font-size: 12px;
      line-height: 1.4;
      pointer-events: none;
      opacity: 0;
      z-index: 30;
      border: 1px solid #2a2a2a;
      color: var(--text);
      transition: opacity 0.1s ease;
    }
    .trend-caption {
      font-size: 12px;
      color: #999;
      margin-top: 6px;
    }
    .line-chart-title { margin: 0 0 6px; font-size: 18px; font-weight: 800; color: #f2f2f2; }
    .line-chart-subtitle { margin: 0 0 8px; font-size: 12px; color: var(--muted); }
    .line-chart-legend { display: flex; gap: 16px; margin-bottom: 8px; font-size: 12px; color: #e8e8e8; flex-wrap: wrap; }
    .line-legend-chip { width: 12px; height: 12px; border-radius: 6px; display: inline-block; }
    .article-tail {
      margin: 50px auto 0;
      padding: 0 4px 30px;
      max-width: 960px;
      color: #f0f0f0;
    }
    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0 18px;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
    }
    .pill-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 12px;
      border-radius: 16px;
      border: 1px solid #2a2a2a;
      background: #171717;
      color: #e6e6e6;
      font-size: 12px;
      text-decoration: none;
    }
    .pill-btn:hover { border-color: #3a3a3a; background: #1d1d1d; }
    .edition-card {
      display: grid;
      grid-template-columns: 160px minmax(0, 1fr);
      column-gap: 12px;
      gap: 12px;
      padding: 12px;
      border: 1px solid #2a2a2a;
      background: #131313;
      border-radius: 10px;
      margin: 14px 0 16px;
      align-items: start;
    }
    .edition-thumb {
      flex: 0 0 160px;
      width: 160px;
      height: 200px;
      background: #1d1d1d;
      border: 1px solid #2f2f2f;
      border-radius: 6px;
      display: grid;
      place-items: center;
      color: #cfcfcf;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      font-weight: 700;
      font-size: 12px;
    }
    .edition-meta h4 {
      margin: 0 0 6px;
      font-size: 15px;
      color: #f4f4f4;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
    }
    .edition-meta p {
      margin: 0 0 8px;
      font-size: 13px;
      color: #c7c7c7;
      line-height: 1.45;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
    }
    .share-row {
      display: flex;
      gap: 8px;
      margin: 8px 0 18px;
      flex-wrap: wrap;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
    }
    .share-btn {
      padding: 7px 11px;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
      background: #171717;
      font-size: 12px;
      color: #ececec;
      cursor: pointer;
    }
    .share-btn:hover { background: #1f1f1f; }
    .newsletter-box {
      padding: 14px;
      border: 1px solid #2a2a2a;
      background: #151515;
      border-radius: 10px;
      margin: 18px 0 24px;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
    }
    .newsletter-box h4 {
      margin: 0 0 6px;
      font-size: 14px;
      color: #f2f2f2;
    }
    .newsletter-box p {
      margin: 0 0 10px;
      font-size: 13px;
      color: #c7c7c7;
    }
    .newsletter-box button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #0b82ff;
      background: #0b82ff;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }
    .newsletter-box button:hover { background: #0d8eff; }
    .more-grid {
      margin: 18px 0 20px;
      border-top: 1px solid #2a2a2a;
      padding-top: 12px;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
    }
    .more-title {
      font-weight: 800;
      font-size: 14px;
      color: #f3f3f3;
      margin: 0 0 10px;
    }
    .more-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .more-card {
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 10px;
      background: #141414;
      color: #e8e8e8;
    }
    .more-card h5 {
      margin: 0 0 6px;
      font-size: 14px;
      color: #f0f0f0;
    }
    .more-card p {
      margin: 0;
      font-size: 12px;
      color: #c5c5c5;
      line-height: 1.4;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
    }
    .site-footer {
      background: #161616;
      color: #d8d8d8;
      padding: 30px 0 40px;
      margin-top: 32px;
      width: 100%;
      border-top: 1px solid #2a2a2a;
    }
    .footer-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 32px;
      width: 100%;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
    }
    .footer-col h4 {
      margin: 0 0 8px;
      font-family: "Playfair Display", Georgia, serif;
      font-size: 13px;
      color: #f1f1f1;
      font-weight: 800;
    }
    .footer-col a {
      display: block;
      color: #c7c7c7;
      text-decoration: none;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .footer-col a:hover { text-decoration: underline; }
    .footer-meta {
      max-width: 1100px;
      margin: 12px auto 0;
      padding: 0 32px;
      text-align: center;
      color: #b5b5b5;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      font-size: 11px;
      line-height: 1.4;
    }
    @media (max-width: 960px) {
      .layout { grid-template-columns: minmax(0, 1fr); }
      .state-card { position: static; }
      .map-shell { min-height: 420px; }
    }
    @media (max-width: 920px) {
      .top-bar {
        display: grid;
        grid-template-columns: 42px 1fr auto;
        align-items: center;
        justify-content: initial;
        column-gap: 10px;
      }
      .icon-btn {
        position: static;
        left: auto;
        justify-self: start;
      }
      .logo {
        position: static;
        transform: none;
        margin-left: 0;
        text-align: center;
        width: 100%;
      }
      .header-actions {
        position: static;
        justify-self: end;
      }
      .nav-row {
        justify-content: flex-start;
        padding-left: 22px;
        margin-top: -45px;
      }
    }
    @media (max-width: 720px) {
      main { padding: 130px 18px 80px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="top-bar">
        <button class="icon-btn" aria-label="menu">‚â°</button>
        <div class="logo">
          Cibercultura
          <small>veritas lux mea</small>
        </div>
        <div class="header-actions">
          <div class="avatar-circle">üë§</div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="nav-row">
      <nav class="subnav">
        <a href="#">Espa√±a</a>
        <a href="#">An√°lisis</a>
        <a href="#">Opini√≥n</a>
        <a href="#">Reportaje</a>
        <a href="#">Noticia</a>
        <a href="#">Entrevista</a>
        <a href="#">Internacional</a>
      </nav>
    </div>

    <section class="hero">
      <div class="kicker">Sociedad</div>
      <h1>Cuando el alquiler ya no responde al esfuerzo: evidencia desde 51 Estados de EE. UU.</h1>
      <p class="dek">La presi√≥n estructural de los alquileres en Estados Unidos se asocia a m√°s d√≠as de vida cotidiana ‚Äúcancelada‚Äù por motivos de salud, a trav√©s de una capa gruesa de estr√©s cr√≥nico, pero tambi√©n mediante v√≠as directas que el modelo solo alcanza a captar de forma parcial</p>
      <p class="date">11 de octubre, 2025</p>
      <div class="save-share">
        <button aria-label="Guardar">Guardar</button>
        <button aria-label="Compartir">Compartir</button>
      </div>
    </section>

    <section class="map-stack">
      <!-- GRPIP_mean -->
      <section class="metric-block" id="grpip-block">
        <div class="layout">
          <div class="map-block">
            <div class="map-shell">
              <button id="search-toggle-grpip" class="map-search-btn" title="Ï£º Í≤ÄÏÉâ Ïó¥Í∏∞/Îã´Í∏∞">üîç</button>
              <div id="search-panel-grpip" class="map-search-panel">
                <input id="search-input-grpip" type="text" placeholder="Introduzca el nombre del estado o selecci√≥nelo de la lista inferior." />
                <div id="search-list-grpip" class="search-list"></div>
              </div>

              <div class="year-select" id="year-select-grpip">
                <button class="year-select-btn" id="year-select-btn-grpip">2023 ‚ñº</button>
                <div class="year-dropdown" id="year-dropdown-grpip"></div>
              </div>

              <div class="map-zoom">
                <button class="zoom-btn" id="zoom-in-grpip" aria-label="Zoom In">+</button>
                <button class="zoom-btn" id="zoom-out-grpip" aria-label="Zoom Out">‚àí</button>
              </div>

              <div id="map-grpip" class="map-target"></div>
            </div>

            <div id="legend-container-grpip" class="legend-steps">
              <div class="legend-title" id="legend-title-grpip">Alquiler bruto como porcentaje de los ingresos del hogar en los √∫ltimos 12 meses.</div>
              <div class="legend-steps-row" id="legend-steps-row-grpip"></div>
              <div class="legend-caption">Datos del ACS public use microdata sample (PUMS). Washington, D.C. :U.S. Census Bureau.</div>
            </div>
          </div>

          <aside class="state-card">
            <div class="state-card-title" id="state-title-grpip">United States</div>
            <div class="state-card-subtitle" id="state-subtitle-grpip">Cuando seleccione un estado en el mapa de la izquierda o lo busque, el valor aparecer√° en este recuadro.</div>

            <div class="state-card-grid">
              <div class="state-card-box">
                <div class="state-card-label">Alquiler bruto como porcentaje de los ingresos del hogar en los √∫ltimos 12 meses.</div>
                <div class="state-card-value" id="state-value-grpip">-</div>
              </div>
              <div class="state-card-box">
                <div class="state-card-label">Rank</div>
                <div class="state-card-rank" id="state-rank-grpip">-</div>
              </div>
            </div>
          </aside>
        </div>

        <section class="ranking-section">
          <div class="ranking-grid">
            <div>
              <div class="ranking-column-title">Top States</div>
              <ul class="ranking-list" id="top-states-list-grpip"></ul>
            </div>
            <div>
              <div class="ranking-column-title">Bottom States</div>
              <ul class="ranking-list" id="bottom-states-list-grpip"></ul>
            </div>
          </div>
          <button id="view-all-btn">Ver todos los estados</button>
        </section>

        <div id="all-states-modal">
          <div class="modal-panel">
            <div class="modal-header">
              <div class="modal-title">Frequent Mental Distress by State (All States)</div>
              <button class="modal-close" id="modal-close-btn" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
              <table>
                <thead>
                  <tr>
                    <th>State</th>
                    <th class="td-right">Rank</th>
                    <th class="td-right">Value</th>
                  </tr>
                </thead>
                <tbody id="all-states-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <section>
          <h2>GRPIP Trends (United States)</h2>
          <p>Muestra la evoluci√≥n media de Estados Unidos calculada a partir del promedio del GRPIP de todos los estados en cada a√±o.</p>
          <div id="trend-chart"></div>
        <div class="trend-caption">Cada punto de la l√≠nea representa la media simple del GRPIP de todos los estados incluidos en ese a√±o.</div>
      </section>
    </section>

    <section class="article-intro" style="max-width: 880px; margin-top: 10px;">
      <p class="article-body">La primera variable clave es la presi√≥n de vivienda en alquiler, definida como la proporci√≥n de la renta del hogar que se destina al pago mensual de la vivienda alquilada y como la fracci√≥n de hogares que superan umbrales elevados de esfuerzo econ√≥mico solo para mantener un techo. Este indicador se calcula a partir de la informaci√≥n individual de ingresos y de pago mensual de vivienda y se agrega por Estado y a√±o. Un valor alto expresa que, en esa jurisdicci√≥n y en ese momento, el espacio disponible para otros usos del ingreso se reduce de manera considerable y que la vivienda compite de forma intensa con el resto de necesidades b√°sicas del hogar.</p>
    </section>

    <!-- Prevalence_FrequentMentalDistress -->
    <section class="metric-block" id="fmd-block">
      <div class="layout">
          <div class="map-block">
            <div class="map-shell">
              <button id="search-toggle-fmd" class="map-search-btn" title="Ï£º Í≤ÄÏÉâ Ïó¥Í∏∞/Îã´Í∏∞">üîç</button>
              <div id="search-panel-fmd" class="map-search-panel">
                <input id="search-input-fmd" type="text" placeholder="Introduzca el nombre del estado o selecci√≥nelo de la lista inferior." />
                <div id="search-list-fmd" class="search-list"></div>
              </div>

              <div class="year-select" id="year-select-fmd">
                <button class="year-select-btn" id="year-select-btn-fmd">2023 ‚ñº</button>
                <div class="year-dropdown" id="year-dropdown-fmd"></div>
              </div>

              <div class="map-zoom">
                <button class="zoom-btn" id="zoom-in-fmd" aria-label="Zoom In">+</button>
                <button class="zoom-btn" id="zoom-out-fmd" aria-label="Zoom Out">‚àí</button>
              </div>

              <div id="map-fmd" class="map-target"></div>
            </div>

            <div id="legend-container-fmd" class="legend-steps">
              <div class="legend-title" id="legend-title-fmd">Prevalence_FrequentMentalDistress</div>
              <div class="legend-steps-row" id="legend-steps-row-fmd"></div>
              <div class="legend-caption">Datos del U.S. Department of Health and Human Services, Centers for Disease Control and Prevention, Behavioral Risk Factor Surveillance System</div>
            </div>
          </div>

          <aside class="state-card">
            <div class="state-card-title" id="state-title-fmd">United States</div>
            <div class="state-card-subtitle" id="state-subtitle-fmd">Cuando seleccione un estado en el mapa de la izquierda o lo busque, el valor aparecer√° en este recuadro.</div>

            <div class="state-card-grid">
              <div class="state-card-box">
                <div class="state-card-label">14+ d√≠as con mala salud mental</div>
                <div class="state-card-value" id="state-value-fmd">-</div>
              </div>
              <div class="state-card-box">
                <div class="state-card-label">Rank</div>
                <div class="state-card-rank" id="state-rank-fmd">-</div>
              </div>
            </div>
          </aside>
        </div>

        <section class="ranking-section">
          <div class="ranking-grid">
            <div>
              <div class="ranking-column-title">Top States</div>
              <ul class="ranking-list" id="top-states-list-fmd"></ul>
            </div>
            <div>
              <div class="ranking-column-title">Bottom States</div>
              <ul class="ranking-list" id="bottom-states-list-fmd"></ul>
            </div>
          </div>
          <button id="view-all-btn-fmd">Ver todos los estados</button>
        </section>

        <div id="all-states-modal-fmd">
          <div class="modal-panel">
            <div class="modal-header">
              <div class="modal-title">Prevalence_FrequentMentalDistress by State (All States)</div>
              <button class="modal-close" id="modal-close-btn-fmd" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
              <table>
                <thead>
                  <tr>
                    <th>State</th>
                    <th class="td-right">Rank</th>
                    <th class="td-right">Value</th>
                  </tr>
                </thead>
                <tbody id="all-states-table-body-fmd"></tbody>
              </table>
            </div>
          </div>
        </div>

        <section>
          <h2>FrequentMentalDistress Trends (United States)</h2>
          <p>Muestra la evoluci√≥n media de Estados Unidos calculada a partir del promedio del malestar mental frecuente de todos los estados en cada a√±o.</p>
          <div id="trend-chart-fmd"></div>
        <div class="trend-caption">Cada punto de la l√≠nea representa la media simple del malestar mental frecuente de todos los estados incluidos en ese a√±o.</div>
      </section>
    </section>

    <section class="article-intro" style="max-width: 880px; margin-top: 10px;">
      <p class="article-body">La segunda variable central es el malestar mental de car√°cter frecuente, medido como la proporci√≥n de personas adultas que declaran al menos catorce d√≠as de salud mental mala en los √∫ltimos treinta d√≠as. Esta medida sintetiza un estado de tensi√≥n prolongada que rebasa los episodios puntuales de preocupaci√≥n y se aproxima m√°s a un clima de angustia que reaparece a lo largo del mes. A escala estatal, niveles elevados de este indicador sugieren que una parte importante de la poblaci√≥n arrastra dificultades emocionales y cognitivas que pueden afectar tanto a la percepci√≥n de control sobre la propia vida como a la capacidad de mantener rutinas de trabajo, cuidado y sociabilidad.</p>
    </section>

    <!-- Promedio_POORHLTH -->
    <section class="metric-block" id="poorhlth-block">
      <div class="layout">
          <div class="map-block">
            <div class="map-shell">
              <button id="search-toggle-poorhlth" class="map-search-btn" title="Ï£º Í≤ÄÏÉâ Ïó¥Í∏∞/Îã´Í∏∞">üîç</button>
              <div id="search-panel-poorhlth" class="map-search-panel">
                <input id="search-input-poorhlth" type="text" placeholder="Introduzca el nombre del estado o selecci√≥nelo de la lista inferior." />
                <div id="search-list-poorhlth" class="search-list"></div>
              </div>

              <div class="year-select" id="year-select-poorhlth">
                <button class="year-select-btn" id="year-select-btn-poorhlth">2023 ‚ñº</button>
                <div class="year-dropdown" id="year-dropdown-poorhlth"></div>
              </div>

              <div class="map-zoom">
                <button class="zoom-btn" id="zoom-in-poorhlth" aria-label="Zoom In">+</button>
                <button class="zoom-btn" id="zoom-out-poorhlth" aria-label="Zoom Out">‚àí</button>
              </div>

              <div id="map-poorhlth" class="map-target"></div>
            </div>

            <div id="legend-container-poorhlth" class="legend-steps">
              <div class="legend-title" id="legend-title-poorhlth">Promedio_POORHLTH</div>
              <div class="legend-steps-row" id="legend-steps-row-poorhlth"></div>
              <div class="legend-caption">Datos del U.S. Department of Health and Human Services, Centers for Disease Control and Prevention, Behavioral Risk Factor Surveillance System</div>
            </div>
          </div>

          <aside class="state-card">
            <div class="state-card-title" id="state-title-poorhlth">United States</div>
            <div class="state-card-subtitle" id="state-subtitle-poorhlth">Cuando seleccione un estado en el mapa de la izquierda o lo busque, el valor aparecer√° en este recuadro.</div>

            <div class="state-card-grid">
              <div class="state-card-box">
                <div class="state-card-label">Durante los √∫ltimos 30 d√≠as, ¬ødurante cu√°ntos d√≠as la mala salud f√≠sica o mental le impidi√≥ realizar sus actividades habituales, como cuidarse, trabajar o dedicarse a actividades de ocio?</div>
                <div class="state-card-value" id="state-value-poorhlth">-</div>
              </div>
              <div class="state-card-box">
                <div class="state-card-label">Rank</div>
                <div class="state-card-rank" id="state-rank-poorhlth">-</div>
              </div>
            </div>
          </aside>
        </div>

        <section class="ranking-section">
          <div class="ranking-grid">
            <div>
              <div class="ranking-column-title">Top States</div>
              <ul class="ranking-list" id="top-states-list-poorhlth"></ul>
            </div>
            <div>
              <div class="ranking-column-title">Bottom States</div>
              <ul class="ranking-list" id="bottom-states-list-poorhlth"></ul>
            </div>
          </div>
          <button id="view-all-btn-poorhlth">Ver todos los estados</button>
        </section>

        <div id="all-states-modal-poorhlth">
          <div class="modal-panel">
            <div class="modal-header">
              <div class="modal-title">Promedio_POORHLTH by State (All States)</div>
              <button class="modal-close" id="modal-close-btn-poorhlth" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
              <table>
                <thead>
                  <tr>
                    <th>State</th>
                    <th class="td-right">Rank</th>
                    <th class="td-right">Value</th>
                  </tr>
                </thead>
                <tbody id="all-states-table-body-poorhlth"></tbody>
              </table>
            </div>
          </div>
        </div>

        <section>
          <h2>Promedio_POORHLTH Trends (United States)</h2>
          <p>Muestra la evoluci√≥n media de Estados Unidos calculada a partir del promedio del POORHLTH de todos los estados en cada a√±o.</p>
          <div id="trend-chart-poorhlth"></div>
          <div class="trend-caption">Cada punto de la l√≠nea representa la media simple del POORHLTH de todos los estados incluidos en ese a√±o.</div>
        </section>
      </section>
      <section class="article-intro" style="max-width: 880px; margin-top: 12px; margin-bottom: 18px;">
        <p class="article-body">La tercera variable describe el n√∫mero medio de d√≠as, dentro de un periodo de treinta, en los que la mala salud f√≠sica o mental impide realizar actividades habituales como el trabajo remunerado, el autocuidado o el ocio. Cuando este valor crece, la vida cotidiana se fragmenta en m√°s jornadas en las que la persona no acude al empleo, no sostiene la misma intensidad de cuidados o no participa en actividades sociales que dan estructura al tiempo. A nivel agregado, un Estado con muchos d√≠as de este tipo se convierte en un entorno donde la capacidad funcional media de la poblaci√≥n se reduce de forma tangible y el margen para implicarse en iniciativas colectivas se estrecha.</p>
        <p class="article-body">El an√°lisis estad√≠stico se articula mediante modelos lineales multinivel, con intercepto espec√≠fico para cada Estado, que diferencian entre dos planos. Por un lado, se estudian las diferencias estructurales entre Estados, mediante la media a largo plazo de la presi√≥n de vivienda, del malestar mental y de los d√≠as de actividad limitada. Por otro lado, se analizan las desviaciones anuales de cada Estado respecto a su propia media, que permiten captar c√≥mo reaccionan estos indicadores cuando el contexto de vivienda se aparta de lo habitual en un territorio concreto.</p>
        <p class="article-body">Los resultados muestran que, dentro de un mismo Estado, los a√±os en los que la presi√≥n de vivienda aumenta por encima de la media hist√≥rica van acompa√±ados de un leve incremento del porcentaje de adultos con muchos d√≠as de salud mental mala. La intensidad de esta relaci√≥n es moderada, pero coherente con la idea de que las sacudidas en el precio de la vivienda introducen incertidumbre adicional en el circuito que conecta esfuerzo, ingresos y estabilidad residencial. No se observa, en cambio, una asociaci√≥n clara entre el nivel medio de presi√≥n de vivienda de cada Estado y el nivel medio de malestar mental, lo que sugiere que la poblaci√≥n se adapta en parte a contextos hist√≥ricamente caros, mientras que reacciona con m√°s sensibilidad a cambios recientes.</p>
        <p class="article-body">La relaci√≥n entre malestar mental y d√≠as de actividad limitada resulta mucho m√°s marcada. Los Estados que mantienen de forma estructural una proporci√≥n elevada de adultos con muchos d√≠as de mala salud mental registran tambi√©n muchos m√°s d√≠as en los que la poblaci√≥n deja de hacer su vida habitual por motivos de salud, incluso cuando el modelo incorpora el paso del tiempo y la presi√≥n de vivienda. Adem√°s, los incrementos anuales del malestar dentro de un mismo Estado se asocian a aumentos del n√∫mero de jornadas en las que la mala salud interrumpe actividades cotidianas. El malestar mental prolongado aparece as√≠ como un condicionante de fondo de la capacidad funcional de la poblaci√≥n y como una variable sensible a los cambios en las condiciones materiales.</p>
        <p class="article-body">La presi√≥n de vivienda influye de forma directa en los d√≠as de actividad limitada cuando se observa el plano estructural entre Estados. All√≠ donde la vivienda en alquiler consume una fracci√≥n elevada del presupuesto de los hogares de manera persistente, los d√≠as en los que la mala salud impide trabajar, cuidar o participar en actividades sociales resultan m√°s frecuentes, incluso en comparaci√≥n con Estados que presentan niveles similares de malestar mental. Esta huella apunta a mecanismos adicionales que van desde la falta de tiempo libre por jornadas laborales prolongadas hasta trayectorias residenciales que desplazan a la poblaci√≥n hacia zonas con peores condiciones de acceso a servicios y redes sociales.</p>
        <p class="article-body">Sin embargo, a corto plazo, las variaciones anuales de la presi√≥n de vivienda dentro de un mismo Estado no siguen un patr√≥n tan intuitivo cuando se introducen de forma simult√°nea en el modelo con el malestar mental. En algunos a√±os en los que la vivienda se encarece respecto a la media del propio Estado, los d√≠as de actividad limitada no aumentan, e incluso aparecen se√±ales en direcci√≥n contraria. Esa paradoja sugiere que la subida de precios puede coincidir con cambios en la composici√≥n de la poblaci√≥n residente, con fases de auge econ√≥mico que elevan tanto los ingresos como los alquileres o con procesos de desplazamiento interno que el panel estatal no permite observar con detalle.</p>
        <p class="article-body">La imagen final no describe una cadena simple en la que la presi√≥n de vivienda se dirige siempre al malestar mental y, desde ah√≠, a los d√≠as de vida interrumpida. M√°s bien dibuja un escenario de doble v√≠a en el que el malestar cr√≥nico estructura con fuerza el n√∫mero de jornadas perdidas por mala salud y la vivienda cara deja, a la vez, una huella directa sobre la posibilidad de sostener la vida cotidiana. All√≠ donde el alquiler se asienta sobre una fracci√≥n elevada de la renta, el circuito que vincula esfuerzo, control y resultados se vuelve fr√°gil, la se√±al de error se acumula y la agenda de trabajo, cuidados y participaci√≥n se llena de huecos que no se explican solo por decisiones individuales, sino por la arquitectura material del mercado de vivienda.</p>
      </section>
    </section>
  </main>

  <section class="article-tail">
    <div class="tag-row">
      <a class="pill-btn" href="#">Explorar m√°s</a>
      <a class="pill-btn" href="#">Opini√≥n</a>
      <a class="pill-btn" href="#">Columnas</a>
      <a class="pill-btn" href="#">Noticia</a>
      <a class="pill-btn" href="#">Sociedad</a>
      <a class="pill-btn" href="#">Econom√≠a</a>
    </div>

    <div class="edition-card">
      <div class="edition-thumb">Edici√≥n</div>
      <div class="edition-meta">
        <h4>De la edici√≥n del 6 de diciembre de 2025</h4>
        <p>Descubra historias de esta secci√≥n y m√°s en el √≠ndice de contenidos.</p>
        <a class="pill-btn" href="#">Explorar la edici√≥n</a>
      </div>
    </div>

    <div class="share-row">
      <button class="share-btn">Guardar</button>
      <button class="share-btn">Compartir</button>
      <button class="share-btn">Reutilizar este contenido</button>
    </div>

    <div class="newsletter-box">
      <h4>Suscr√≠base a nuestro bolet√≠n</h4>
      <p>Su gu√≠a para las agon√≠as de la vida de oficina.</p>
      <button>Suscribirse</button>
    </div>

    <div class="more-grid">
      <div class="more-title">M√°s en Econom√≠a</div>
      <div class="more-items">
        <div class="more-card">
          <h5>¬øDestruir√° la ola de megafusiones valor para los accionistas?</h5>
          <p>Es una moneda al aire.</p>
        </div>
        <div class="more-card">
          <h5>Para frenar su declive, Volkswagen y otros miran hacia China</h5>
          <p>Los fabricantes de autom√≥viles extranjeros est√°n localizando sus operaciones.</p>
        </div>
        <div class="more-card">
          <h5>Patrick Drahi ha vuelto a imponerse a sus acreedores</h5>
          <p>La reestructuraci√≥n de deuda m√°s ca√≥tica del mundo acaba de ponerse a√∫n m√°s fea.</p>
        </div>
        <div class="more-card">
          <h5>Hasta los fabricantes europeos de bol√≠grafos est√°n en peligro</h5>
          <p>Pero una peculiar marca italiana est√° prosperando.</p>
        </div>
        <div class="more-card">
          <h5>De los microdramas a los videojuegos, el entretenimiento chino vive un auge</h5>
          <p>¬øCu√°nta libertad dar√° el Partido Comunista a los creadores?</p>
        </div>
      </div>
    </div>
  </section>

  <footer class="site-footer">
    <div class="footer-inner">
      <div class="footer-col">
        <h4>Cibercultura</h4>
        <a href="#">Acerca de</a>
        <a href="#">Reutilizar nuestro contenido</a>
        <a href="#">Suscripci√≥n</a>
        <a href="#">Cibercultura Pro</a>
        <a href="#">SecureDrop</a>
      </div>
      <div class="footer-col">
        <h4>Cibercultura Group</h4>
        <a href="#">Cibercultura Insights</a>
        <a href="#">Cibercultura Impact</a>
        <a href="#">Cibercultura Impact Events</a>
        <a href="#">Education Courses</a>
      </div>
      <div class="footer-col">
        <h4>Contacto</h4>
        <a href="#">Ayuda y asistencia</a>
        <a href="#">Publicidad</a>
        <a href="#">Centro de prensa</a>
        <a href="#">Programa de afiliados</a>
      </div>
      <div class="footer-col">
        <h4>Empleo</h4>
        <a href="#">Trabajar aqu√≠</a>
        <a href="#">Puestos ejecutivos</a>
      </div>
    </div>
    <div class="footer-meta">¬© Cibercultura 2025 ¬∑ T√©rminos ¬∑ Privacidad ¬∑ Cookies</div>
  </footer>

  <script>
    const mapWidth = 1000;
    const mapHeight = 600;
    const palette = [getComputedStyle(document.documentElement).getPropertyValue('--palette-1').trim(), getComputedStyle(document.documentElement).getPropertyValue('--palette-2').trim(), getComputedStyle(document.documentElement).getPropertyValue('--palette-3').trim(), getComputedStyle(document.documentElement).getPropertyValue('--palette-4').trim(), getComputedStyle(document.documentElement).getPropertyValue('--palette-5').trim()];
    const noDataColor = getComputedStyle(document.documentElement).getPropertyValue('--no-data').trim();

    const dataPromise = d3.dsv(";", "data.csv", d => ({
      YEAR: +d.YEAR,
      STATE: d.STATE,
      GRPIP_mean: +d.GRPIP_mean,
      Prevalence_FrequentMentalDistress: +d.Prevalence_FrequentMentalDistress,
      Promedio_POORHLTH: +d.Promedio_POORHLTH
    }));

    const geoPromise = d3.json("us-states.json");

    Promise.all([dataPromise, geoPromise]).then(([data, us]) => {
      initMetric({
        key: "grpip",
        title: "GRPIP_mean",
        valueField: "GRPIP_mean",
        data,
        features: us.features,
        mapTarget: "#map-grpip",
        searchToggle: "search-toggle-grpip",
        searchPanel: "search-panel-grpip",
        searchInput: "search-input-grpip",
        searchList: "search-list-grpip",
        yearSelectBtn: "year-select-btn-grpip",
        yearDropdown: "year-dropdown-grpip",
        legendTitleId: "legend-title-grpip",
        zoomIn: "zoom-in-grpip",
        zoomOut: "zoom-out-grpip",
        legendRow: "legend-steps-row-grpip",
        stateTitle: "state-title-grpip",
        stateSubtitle: "state-subtitle-grpip",
        stateValue: "state-value-grpip",
        stateRank: "state-rank-grpip",
        topList: "top-states-list-grpip",
        bottomList: "bottom-states-list-grpip",
        viewAllBtn: "view-all-btn",
        modal: "all-states-modal",
        modalClose: "modal-close-btn",
        tableBody: "all-states-table-body",
        trendTarget: "#trend-chart",
        tooltipClass: "tooltip"
      });

      initMetric({
        key: "fmd",
        title: "Prevalence_FrequentMentalDistress",
        valueField: "Prevalence_FrequentMentalDistress",
        data,
        features: us.features,
        mapTarget: "#map-fmd",
        searchToggle: "search-toggle-fmd",
        searchPanel: "search-panel-fmd",
        searchInput: "search-input-fmd",
        searchList: "search-list-fmd",
        yearSelectBtn: "year-select-btn-fmd",
        yearDropdown: "year-dropdown-fmd",
        legendTitleId: "legend-title-fmd",
        zoomIn: "zoom-in-fmd",
        zoomOut: "zoom-out-fmd",
        legendRow: "legend-steps-row-fmd",
        stateTitle: "state-title-fmd",
        stateSubtitle: "state-subtitle-fmd",
        stateValue: "state-value-fmd",
        stateRank: "state-rank-fmd",
        topList: "top-states-list-fmd",
        bottomList: "bottom-states-list-fmd",
        viewAllBtn: "view-all-btn-fmd",
        modal: "all-states-modal-fmd",
        modalClose: "modal-close-btn-fmd",
        tableBody: "all-states-table-body-fmd",
        trendTarget: "#trend-chart-fmd",
        tooltipClass: "tooltip",
        multiplier: 100
      });

      initMetric({
        key: "poorhlth",
        title: "Promedio_POORHLTH",
        valueField: "Promedio_POORHLTH",
        data,
        features: us.features,
        mapTarget: "#map-poorhlth",
        searchToggle: "search-toggle-poorhlth",
        searchPanel: "search-panel-poorhlth",
        searchInput: "search-input-poorhlth",
        searchList: "search-list-poorhlth",
        yearSelectBtn: "year-select-btn-poorhlth",
        yearDropdown: "year-dropdown-poorhlth",
        legendTitleId: "legend-title-poorhlth",
        zoomIn: "zoom-in-poorhlth",
        zoomOut: "zoom-out-poorhlth",
        legendRow: "legend-steps-row-poorhlth",
        stateTitle: "state-title-poorhlth",
        stateSubtitle: "state-subtitle-poorhlth",
        stateValue: "state-value-poorhlth",
        stateRank: "state-rank-poorhlth",
        topList: "top-states-list-poorhlth",
        bottomList: "bottom-states-list-poorhlth",
        viewAllBtn: "view-all-btn-poorhlth",
        modal: "all-states-modal-poorhlth",
        modalClose: "modal-close-btn-poorhlth",
        tableBody: "all-states-table-body-poorhlth",
        trendTarget: "#trend-chart-poorhlth",
        tooltipClass: "tooltip"
      });
    }).catch(err => console.error("Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ Ï§ë Ïò§Î•ò:", err));

    function initMetric(opts) {
      const {
        title,
        valueField,
        data,
        features,
        mapTarget,
        searchToggle,
        searchPanel,
        searchInput,
        searchList,
        yearSelectBtn,
        yearDropdown,
        legendTitleId,
        zoomIn,
        zoomOut,
        legendRow,
        stateTitle,
        stateSubtitle,
        stateValue,
        stateRank,
        topList,
        bottomList,
        viewAllBtn,
        modal,
        modalClose,
        tableBody,
        trendTarget,
        tooltipClass,
        multiplier = 1
      } = opts;

      const svg = d3.select(mapTarget)
        .append("svg")
        .attr("viewBox", `0 0 ${mapWidth} ${mapHeight}`)
        .style("width", "100%")
        .style("height", "auto");

      const mapGroup = svg.append("g");

      const projection = d3.geoAlbersUsa()
        .translate([mapWidth / 2, mapHeight / 2])
        .scale(1200);

      const path = d3.geoPath(projection);
      const tooltip = d3.select("body").append("div").attr("class", tooltipClass);

      const stateTitleEl = document.getElementById(stateTitle);
      const stateSubtitleEl = document.getElementById(stateSubtitle);
      const stateValueEl = document.getElementById(stateValue);
      const stateRankEl = document.getElementById(stateRank);

      const searchToggleBtn = document.getElementById(searchToggle);
      const searchPanelEl = document.getElementById(searchPanel);
      const searchInputEl = document.getElementById(searchInput);
      const searchListSel = d3.select("#" + searchList);

      const yearSelectBtnEl = document.getElementById(yearSelectBtn);
      const yearDropdownEl = document.getElementById(yearDropdown);
      const legendTitleEl = document.getElementById(legendTitleId);

      const topListSel = d3.select("#" + topList);
      const bottomListSel = d3.select("#" + bottomList);
      const viewAllBtnEl = document.getElementById(viewAllBtn);
      const modalEl = document.getElementById(modal);
      const modalCloseBtn = document.getElementById(modalClose);
      const allStatesTbody = d3.select("#" + tableBody);

      let rankByState = new Map();
      let valueByState = new Map();
      let totalStates = 0;
      let lastSelectedState = null;
      let sortedData = [];
      let color = null;

      const availableYears = Array.from(
        new Set(
          data
            .filter(d => !isNaN(d[valueField]))
            .map(d => d.YEAR)
        )
      ).sort((a, b) => b - a);

      let selectedYear = availableYears[0] || 2023;

      prepareYearData(selectedYear);

      function prepareYearData(year) {
        const yearData = data
          .filter(d => d.YEAR === year && !isNaN(d[valueField]))
          .map(d => ({ ...d, _value: d[valueField] * multiplier }));

        // Descending sort so highest value = rank 1
        sortedData = yearData.slice().sort((a, b) => b._value - a._value);
        totalStates = sortedData.length;
        rankByState = new Map();
        valueByState = new Map(sortedData.map(d => [d.STATE, d._value]));
        sortedData.forEach((d, i) => {
          rankByState.set(d.STATE, i + 1);
          d.rank = i + 1;
        });

        const values = Array.from(valueByState.values()).filter(v => !isNaN(v));
        const minVal = d3.min(values);
        const maxVal = d3.max(values);
        const domainMin = minVal == null ? 0 : minVal;
        const domainMax = maxVal == null ? domainMin + 1 : (maxVal === domainMin ? domainMin + 1 : maxVal);

        color = d3.scaleQuantize()
          .domain([domainMin, domainMax])
          .range(palette);
      }

      const zoomBehavior = d3.zoom()
        .scaleExtent([1, 8])
        .translateExtent([[0, 0], [mapWidth, mapHeight]])
        .on("zoom", (event) => {
          mapGroup.attr("transform", event.transform);
          currentTransform = event.transform;
        });

      let currentTransform = d3.zoomIdentity;
      svg.call(zoomBehavior);

      document.getElementById(zoomIn).addEventListener("click", () => {
        svg.transition().duration(200).call(zoomBehavior.scaleBy, 1.2);
      });
      document.getElementById(zoomOut).addEventListener("click", () => {
        svg.transition().duration(200).call(zoomBehavior.scaleBy, 0.8);
      });

      mapGroup.selectAll("path")
        .data(features)
        .join("path")
        .attr("class", "state")
        .attr("d", path)
        .attr("fill", d => {
          const stateName = d.properties.NAME;
          const v = valueByState.get(stateName);
          return (v == null || isNaN(v)) ? noDataColor : color(v);
        })
        .attr("stroke", "#fff")
        .attr("stroke-width", 0.6)
        .on("mouseover", function(event, d) {
          const stateName = d.properties.NAME;
          const v = valueByState.get(stateName);
          const rank = rankByState.get(stateName);

          d3.select(this).attr("stroke-width", 1.4);

          if (v == null || isNaN(v)) {
            tooltip.style("opacity", 1).html(`<strong>${stateName}</strong><br>Sin datos del a√±o`);
          } else {
            tooltip
              .style("opacity", 1)
              .html(
                `<strong>${stateName}</strong><br>` +
                `A√±o ${selectedYear} ${title}: ${v.toFixed(1)} %<br>` +
                `Rank: ${rank} / ${totalStates}`
              );
          }
        })
        .on("mousemove", function(event) {
          tooltip
            .style("left", (event.pageX + 12) + "px")
            .style("top", (event.pageY - 32) + "px");
        })
        .on("mouseout", function() {
          d3.select(this).attr("stroke-width", d => {
            const name = d.properties.NAME;
            return (lastSelectedState && name === lastSelectedState) ? 2 : 0.6;
          });
          tooltip.style("opacity", 0);
        })
        .on("click", function(event, d) {
          const stateName = d.properties.NAME;
          selectStateByName(stateName);
        });

      function updateStateCard(stateName) {
        const value = valueByState.get(stateName);
        const rank = rankByState.get(stateName);
        stateTitleEl.textContent = stateName;

        if (value == null || isNaN(value)) {
          stateSubtitleEl.textContent = `No hay datos del a√±o ${selectedYear} para el estado seleccionado.`;
          stateValueEl.textContent = "-";
          stateRankEl.textContent = "-";
        } else {
          stateSubtitleEl.textContent = `Muestra el del ${title} a√±o ${selectedYear} y su posici√≥n dentro del conjunto de estados.`;
          stateValueEl.textContent = value.toFixed(1) + " %";
          stateRankEl.textContent = rank + " / " + totalStates;
        }
      }

      function selectStateByName(stateName) {
        if (!stateName) return;
        stateName = stateName.trim();
        if (!stateName) return;
        updateStateCard(stateName);

        mapGroup.selectAll("path.state")
          .attr("stroke-width", d => d.properties.NAME === stateName ? 2 : 0.6)
          .attr("stroke", d => d.properties.NAME === stateName ? "#1b2a3c" : "#ffffff");

        lastSelectedState = stateName;
      }

      searchToggleBtn.addEventListener("click", () => {
        const open = !searchPanelEl.classList.contains("open");
        if (open) {
          searchPanelEl.classList.add("open");
          searchInputEl.focus();
        } else {
          searchPanelEl.classList.remove("open");
        }
      });

      const stateNames = Array.from(new Set(data.map(d => d.STATE)))
        .sort((a, b) => d3.ascending(a, b));

      searchInputEl.addEventListener("keydown", e => {
        if (e.key === "Enter") {
          const typed = e.target.value;
          if (!typed) return;
          const match = stateNames.find(name => name.toLowerCase() === typed.trim().toLowerCase());
          if (match) selectStateByName(match);
        }
      });

      searchListSel.selectAll("button")
        .data(stateNames)
        .join("button")
        .text(d => d)
        .on("click", (event, d) => selectStateByName(d));

      function updateRankLists() {
        const top5 = sortedData.slice(0, 5);
        const bottom5 = sortedData.slice(-5); // lowest values
        renderRanking(topListSel, top5, rankByState, selectStateByName);
        renderRanking(bottomListSel, bottom5, rankByState, selectStateByName);
      }

      function refreshMapColors() {
        mapGroup.selectAll("path.state")
          .attr("fill", d => {
            const stateName = d.properties.NAME;
            const v = valueByState.get(stateName);
            return (v == null || isNaN(v)) ? noDataColor : color(v);
          })
          .attr("stroke-width", d => {
            const name = d.properties.NAME;
            return (lastSelectedState && name === lastSelectedState) ? 2 : 0.6;
          })
          .attr("stroke", d => {
            const name = d.properties.NAME;
            return (lastSelectedState && name === lastSelectedState) ? "#1b2a3c" : "#ffffff";
          });
      }

      function updateYear(year) {
        selectedYear = year;
        yearSelectBtnEl.textContent = `${year} ‚ñº`;
        legendTitleEl.textContent = `A√±o ${year} ${title}`;
        prepareYearData(year);
        renderLegend(legendRow, color);
        refreshMapColors();
        updateRankLists();

        if (lastSelectedState) {
          updateStateCard(lastSelectedState);
        } else {
          stateSubtitleEl.textContent = `Muestra el ${title} del a√±o ${selectedYear} y su posici√≥n dentro del conjunto de estados.`;
          stateValueEl.textContent = "-";
          stateRankEl.textContent = "-";
        }
      }

      function renderYearDropdown() {
        yearDropdownEl.innerHTML = "";
        availableYears.forEach(year => {
          const btn = document.createElement("button");
          btn.textContent = year;
          btn.addEventListener("click", () => {
            yearDropdownEl.classList.remove("open");
            updateYear(year);
          });
          yearDropdownEl.appendChild(btn);
        });
      }

      yearSelectBtnEl.addEventListener("click", () => {
        yearDropdownEl.classList.toggle("open");
      });

      document.addEventListener("click", (e) => {
        if (!yearDropdownEl.contains(e.target) && e.target !== yearSelectBtnEl) {
          yearDropdownEl.classList.remove("open");
        }
      });

      renderYearDropdown();
      updateYear(selectedYear);

      viewAllBtnEl.addEventListener("click", () => {
        allStatesTbody.selectAll("tr")
          .data(sortedData) // already sorted high to low
          .join("tr")
          .each(function(d) {
            const tr = d3.select(this);
            tr.selectAll("*").remove();

            tr.append("td")
              .append("button")
              .attr("class", "modal-state-button")
              .text(d.STATE)
              .on("click", () => {
                selectStateByName(d.STATE);
                modalEl.classList.remove("open");
              });

            tr.append("td")
              .attr("class", "td-right")
              .text(rankByState.get(d.STATE));

            tr.append("td")
              .attr("class", "td-right")
              .text(d._value.toFixed(1) + " %");
          });

        modalEl.classList.add("open");
      });

      modalCloseBtn.addEventListener("click", () => modalEl.classList.remove("open"));
      modalEl.addEventListener("click", e => { if (e.target === modalEl) modalEl.classList.remove("open"); });

      const byYear = d3.rollups(
        data.filter(d => !isNaN(d[valueField])),
        v => d3.mean(v, d => d[valueField] * multiplier),
        d => d.YEAR
      );

      const trendData = byYear
        .map(([year, value]) => ({ year: +year, value }))
        .sort((a, b) => a.year - b.year);

      drawTrendChart(trendTarget, trendData, title);
    }

    function renderLegend(rowId, colorScale) {
      const thresholds = colorScale.thresholds();
      const domain = colorScale.domain();
      const steps = [];
      let prev = domain[0];
      thresholds.forEach((t, i) => {
        steps.push([prev, t]);
        prev = t;
      });
      steps.push([prev, domain[1]]);

      const row = d3.select("#" + rowId);
      const stepSel = row.selectAll(".legend-step")
        .data(steps.concat([["No Data", "No Data"]]));

      const enter = stepSel.enter()
        .append("div")
        .attr("class", "legend-step");

      enter.append("div").attr("class", "legend-chip");
      enter.append("div").attr("class", "legend-label");

      const merged = enter.merge(stepSel);

      merged.each(function(d, i) {
        const chip = d3.select(this).select(".legend-chip");
        const label = d3.select(this).select(".legend-label");
        if (d[0] === "No Data") {
          chip.style("background", noDataColor);
          label.text("No Data");
        } else {
          const colorVal = colorScale((d[0] + d[1]) / 2);
          label.text(`${d[0].toFixed(1)} - ${d[1].toFixed(1)}%`);
          chip.style("background", colorVal);
        }
      });

      stepSel.exit().remove();
    }

    function renderRanking(listSel, arr, rankMap, onSelect) {
      const items = listSel.selectAll("li").data(arr).join("li");
      items.selectAll("*").remove();
      items.each(function(d) {
        const li = d3.select(this);
        li.append("button").text(d.STATE).on("click", () => onSelect(d.STATE));
        li.append("span").attr("class", "ranking-rank").text(() => rankMap.get(d.STATE));
        li.append("span").attr("class", "ranking-value").text(() => d._value.toFixed(1) + " %");
      });
    }

    function drawTrendChart(targetSelector, trendData, title) {
      const margin = { top: 20, right: 24, bottom: 40, left: 56 };
      const width = 960;
      const height = 320;

      const svg = d3.select(targetSelector)
        .append("svg")
        .attr("viewBox", `0 0 ${width} ${height}`)
        .style("width", "100%")
        .style("height", "auto");

      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;

      const g = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      // 2020ÎÖÑ Îç∞Ïù¥ÌÑ∞ Ï†úÏô∏ + Ï¢åÏ∏° ÎùºÎ≤® Í≤πÏπ® Î∞©ÏßÄÎ•º ÏúÑÌïú Ìå®Îî©
      const filtered = trendData.filter(d => d.year !== 2020);
      const years = filtered.map(d => d.year);

      const x = d3.scalePoint()
        .domain(years)
        .range([0, innerWidth])
        .padding(0.5);

      const yMin = title === "GRPIP_mean" ? 30 : 0;

      const y = d3.scaleLinear()
        .domain([yMin, d3.max(filtered, d => d.value) * 1.1])
        .nice()
        .range([innerHeight, 0]);

      const xAxis = d3.axisBottom(x)
        .tickValues(years)
        .tickFormat(d3.format("d"));

      const yAxis = d3.axisLeft(y)
        .ticks(6)
        .tickFormat(d => d.toFixed(1) + " %");

      g.append("g")
        .attr("stroke", "#2a2a2a")
        .attr("stroke-opacity", 1)
        .call(gGrid => gGrid
          .selectAll("line")
          .data(y.ticks(6))
          .join("line")
          .attr("x1", 0)
          .attr("x2", innerWidth)
          .attr("y1", d => y(d))
          .attr("y2", d => y(d))
        );

      g.append("g")
        .attr("transform", `translate(0,${innerHeight})`)
        .call(xAxis)
        .call(axis => axis.selectAll("text").attr("font-size", 11).attr("fill", "#cfcfcf"))
        .call(axis => axis.selectAll("path,line").attr("stroke", "#3a3a3a"));

      g.append("g")
        .call(yAxis)
        .call(axis => axis.selectAll("text").attr("font-size", 11).attr("fill", "#cfcfcf"))
        .call(axis => axis.selectAll("path,line").attr("stroke", "#3a3a3a"));

      const lineGen = d3.line()
        .x((d, i) => x(years[i]))
        .y(d => y(d))
        .curve(d3.curveMonotoneX);

      g.selectAll(".trend-line")
        .data([filtered])
        .join("path")
        .attr("class", "trend-line")
        .attr("fill", "none")
        .attr("stroke", "#30c0c0")
        .attr("stroke-width", 3)
        .attr("d", d => lineGen(d.map(v => v.value)));

      const tip = d3.select("body").append("div").attr("class", "trend-tooltip");

      g.selectAll(".trend-dot")
        .data(filtered)
        .join("circle")
        .attr("class", "trend-dot")
        .attr("r", 4)
        .attr("cx", d => x(d.year))
        .attr("cy", d => y(d.value))
        .attr("fill", "#30c0c0")
        .attr("stroke", "#0f0f0f")
        .attr("stroke-width", 1)
        .on("mouseover", function(event, d) {
          tip
            .style("opacity", 1)
            .html(`<strong>${d.year}</strong><br>${d.value.toFixed(1)} %`);
        })
        .on("mousemove", function(event) {
          tip
            .style("left", (event.pageX + 12) + "px")
            .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", function() {
          tip.style("opacity", 0);
        });
    }
  </script>
</body>
</html>
